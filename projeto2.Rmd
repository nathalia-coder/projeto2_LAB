---
title: "Projeto 2"
author: 
  - "Nathalia Gabriella Ferreira dos Santos"
  - "Bárbara"
date: "`r Sys.Date()`"
output:
  html_document:
    number_sections: yes
    fig_caption: yes
  pdf_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE, # true mostra o codigo
	message = FALSE,
	warning = FALSE
)
#options(OutDec = ",")
```

```{r pacotes, message=FALSE, warning=FALSE}
library(tidyverse)
library(readxl)
library(patchwork) # para parcionar os graficos
library(kableExtra)
library(janitor)

# rode uma vez soh
devtools::install_github(repo="haozhu233/kableExtra", ref="a6af5c0")
```

```{r limpa_env}
rm(list = ls())
```

```{r tema_graficos}
cor_verde = c("#4fb6a7")
cor_roxa = c("#652177")

cores = colorRampPalette(c("#4fb6a7","#652177"))
tema = theme_minimal() + 
       theme(axis.title.y = element_text(angle = 90, margin = unit(c(0.3, 0.5, 0.3, 0), "cm")),
             axis.title.x = element_text(margin = unit(c(0.3, 0, 0, 0), "cm")),
             axis.line.x = element_line(linewidth = 0.6, linetype=1),
             axis.line.y = element_line(linewidth = 0.6, linetype=1),
             axis.ticks.y = element_line(linewidth = 0.6, linetype = 1),
             axis.text = element_text(size=10),
             legend.position = "right",
             plot.margin = unit(c(0.3, 0.4, 0.3, 0.4), "cm"),
             plot.subtitle = element_text(hjust = 0.5, vjust= 4))
theme_set(tema)
```

## Resumo testes de hipóteses

Para os dados numéricos, os testes tiveram por hipótese geral:

```{=tex}
\begin{eqnarray}
        {
        \left\{\begin{array}{lcc}
        H_{0}: {\theta_{Grupo~MN} = \theta_{Grupo~MP}} \\
        H_{1}: {\theta_{Grupo~MN} \neq \theta_{Grupo~MP}}
        \end{array}\right.
        }    \nonumber
    \end{eqnarray}
```


```{r funcao_teste_hipotese}
realizar_teste <- function(dataframe, variavel) {
  
  alpha <- 0.05
  
  dataframefiltrado <- dataframe %>% drop_na(grupo) %>% mutate(grupo = ifelse(grupo == "0", "MN", "MP")) 
  grupo_MN<- dataframefiltrado %>% filter(grupo == "MN") %>% pull(variavel)
  grupo_MP<- dataframefiltrado %>% filter(grupo == "MP") %>% pull(variavel)
  
  ## Teste Normalidade
  shapiro1 <- shapiro.test(grupo_MN)
  shapiro2 <- shapiro.test(grupo_MP)

  ## Teste de Hipotese - & ou || aqui?
  if (shapiro1$p.value <= alpha || shapiro2$p.value <= alpha) {
    resultado_teste <- wilcox.test(grupo_MN, grupo_MP, correct = FALSE,  alternative = "two.sided")
  } else {
    resultado_teste <- t.test(grupo_MN, grupo_MP, alternative = "two.sided") 
  }

  tabela <- dataframefiltrado %>% group_by(grupo) %>%
    summarise(
      N = sum(!is.na( !!sym(variavel) )),
      Nulo =  sum( is.na( !!sym(variavel) )),
      `Média` = mean( !!sym(variavel) , na.rm = T),
      "DesPad" = sd( !!sym(variavel) , na.rm = T),
      "Min" = min( !!sym(variavel) , na.rm = T),
      "Q1" = quantile( !!sym(variavel) , na.rm = T, .25)[[1]],
      "Mediana" = quantile( !!sym(variavel) , na.rm = T, .5)[[1]],
      "Q3" = quantile( !!sym(variavel) , na.rm = T, .75)[[1]],
      "Máx" = max( !!sym(variavel) , na.rm = T),
      `P(Norm)` = shapiro.test( !!sym(variavel) )$p.value,
      `P(Teste)` = resultado_teste$p.value,
      Conc = if_else(`P(Teste)` >= alpha, "Não sig", "Sig"),
      `Variável` = variavel
    )
  
  tabela <- tabela %>% select(`Variável`, everything())
  return(tabela)
}
```


```{r aplicando_teste_numericos}
### Idade:
variavel <- "idade"
teste <- realizar_teste(df1, variavel)
tabela_resumo <- teste

todas_variaveis <- "imc"
for(variavel in todas_variaveis){
  teste <- realizar_teste(df1, variavel)
  tabela_resumo <- rbind(tabela_resumo, teste)
}
tabela_resumo

kbl(
  tabela_resumo, 
  digits = 2,
  format.args = list(decimal.mark = ',', big.mark = ".") 
  ) %>%
  kable_paper(full_width = F) %>%
  column_spec(1, bold = T) %>%
  collapse_rows(columns = c(1,13:14))
```


```{r}
# Teste de hipóteses para dados categóricos
hipo_categorica <- function(dados, grupo, variavel){
  
  alpha = 0.05

  dados <- dados %>% drop_na(grupo) %>% mutate(grupo = ifelse(grupo == "0", "MN", "MP")) 
  data_grupo <- dados %>% dplyr::select( !!sym(grupo) ) %>% pull( !!sym(grupo) )
  data_variavel <- dados %>% dplyr::select( !!sym(variavel) ) %>% pull( !!sym(variavel) )
  tab = xtabs(~ data_variavel + data_grupo) # tabela de frequencia
  teste <- stats::chisq.test(tab, simulate.p.value = TRUE,  B = 10000)
  
  tabela <- list(
    `Variável` = variavel,
    Categorias = rownames(tab),
    MN = tab[,"MN"],
    `MN(%)` = paste0( (tab[,"MN"]/sum(tab[,"MN"]) * 100) %>% round(2) ,"%" ),
    MP = tab[,"MP"],
    `MP(%)` = paste0( (tab[,"MP"]/sum(tab[,"MP"]) * 100) %>% round(2) ,"%" ),
    `P(Teste)` = teste$p.value
    ) %>% as_tibble() %>% 
    mutate(Conc = if_else(`P(Teste)` >= alpha, "Não sig", "Sig"))
   
  return(tabela)
  }
```


```{r aplicando_teste_categoricos}
### Etnia:
variavel <- "etnia"
teste <- hipo_categorica(df1, "grupo", variavel)
tabela_resumo_cat <- teste

kbl(
  tabela_resumo_cat, 
  digits = 2,
  format.args = list(decimal.mark = ',', big.mark = ".") 
  ) %>%
  kable_paper(full_width = F) %>%
  column_spec(1, bold = T) %>%
  collapse_rows(columns = c(1,7:8))
```

