---
#title: "Projeto I"
#author:
#date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    new_session: true
    number_sections: true
    fig_caption: true
#header-includes: \usepackage[brazil]{babel}
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE, # true mostra o codigo
	message = FALSE,
	warning = FALSE
)
#options(OutDec = ",")
```

```{r pacotes, message=FALSE, warning=FALSE}
library(tidyverse)
library(readxl) 
library(patchwork) # para parcionar os graficos
library(janitor)
library(kableExtra)
library(hnp)
library(gtsummary)
library(rlist)
library(car)
# rode uma vez soh
```

```{r limpa_env}
rm(list = ls())

df1 <- read_xlsx("dados.xlsx", sheet = "Dados Atuais")
df2 <- read_xlsx("dados.xlsx", sheet = "Dados Gestacionais")
df3 <- read_xlsx("dados.xlsx", sheet = "ELISAs")
df4 <- read_xlsx("dados.xlsx", sheet = "Imunoturbidimetria")
df5 <- read_xlsx("dados.xlsx", sheet = "Doenças Crônicas")
df6 <- read_xlsx("dados.xlsx", sheet = "Aspectos Psicológicos")
df7 <- read_xlsx("dados.xlsx", sheet = "SÍNDROME METABÓLICA")
```

```{r funcoes_trata_dados}
##Funções para tratar os dados:

coluna_na_numerica <- function(lista, caracter = ".", substituto = ""){
  lista %>% 
    str_replace(. , pattern = ",", replacement = ".") %>%
    str_replace_na(. , replacement = "") %>% 
    ifelse(. == caracter, substituto, .) %>% as.numeric()
}

coluna_numerica <- function(lista){
  lista %>% 
    ifelse(. == 99999, NA, .) %>% as.numeric()
}
```

```{r tratamento_df1}
#### DF1: Dados Atuais

colunas_interesse <- c(
  "NOME    (iniciais)",
  "GRUPO      MN:0      MP:1",
  "ETNIA                1:branca   2:parda   3:negra",
  "IDADE    anos",
  "ESCOLARIDADE COMPLETA  0: 4ª série completa   1:fundamental completo 2:médio completo 3:ensino técnico completo 4:superior completo 5:pós-graduação completa",
  "DOENÇA CRÔNICA  0:não   1:hipertensão   2:diabetes   3:hipercolesterolemia   4:fibromialgia   5:glaucoma   6:enxaqueca   7:hipotireoidismo   8:asma   9:esteatose hepática   10:síndrome do intestino irritável   11:hemangioma   12:trombofilia   13:bronquite   14:rinite   15:ovário policístico   16:TAG   17:sinusite   18:depressão   19: artrose   20:leucocitose   21:anemia   22:síndrome do pânico   23:gastrite   24:hepatite   25:crise alérgica   26:cistite  27:anemia falciforme   28:mioma uterino   29:cálculo renal   30:calcificação mamária   31:hipoglicemia   32:derrame de vista   33:hidradenite  34:glomeruloesclerose 35:pré-diabetes 36:bipolaridade 37:TDAH 38:TEA 39:Doença de Still",
  "NÚMERO GESTAÇÕES",
  "Grupo sanguíneo ABO         0:A         1:B         2:O          3: AB",
  "RH   0:negativo   1:positivo",
  "Peso (kg)",
  "Altura (m)",
  "IMC",
  "GORDURA (%)",
  "PRESSÃO SISTÓLICA (mmHg)",
  "PRESSÃO DIASTÓLICA (mmHg)",
  "PRESSÃO ARTERIAL MÉDIA",
  "CINTURA (cm)",
  "ABDÔMEN (cm)",
  "QUADRIL (cm)",
  "RELAÇÃO CINTURA/QUADRIL",
  "RBC (106/µL)",
  "HGB (g/dL)",
  "HCT (%)",
  "VCM (µm³)",
  "HCM (pg)",
  "CHCM (g/dL)",
  "RDW-CV (%)",
  "RDW-SD (µm³)",
  "PLT (10³/µL)",
  "PCT (%)",
  "VPM (µm³)",
  "PDW (µm³)",
  "P-LCC (10³/µL)",
  "P-LCR (%)",
  "WBC (10³/µL)",
  "NEU (10³/µL)",
  "LYM (10³/µL)",
  "MON (10³/µL)",
  "EOS (10³/µL)",
  "BASO (10³/µL)",
  "LIC (10³/µL)",
  "NLR",
  "Colesterol total (mg/dL)",
  "HDL (mg/dL)",
  "LDL (mg/dL) DOSADO",
  "VLDL (mg/dL)",
  "Não-HDL (mg/dL)",
  "Triglicérides (mg/dL)",
  "HbA1c (%)",
  "Creatinina (mg/dL)",
  "Ritmo de filtrção glomerular calculado",
  "TGP/ALT",
  "TGO/AST",
  "Ácido Úrico",
  "CK",
  "Gama GT",
  "USA ANTI-HIPERTENSIVO 0:não 1:sim",
  "USA MEDICAMENTO PARA DIABETES 0:não 1:sim",
  "USA MEDICAMENTO PARA HIPERCOLESTEROLEMIA 0:não 1:sim",
  "TABAGISTA 0: não   1:sim", 
  "ETILISTA    0: não   1:sim",
  "Glicemia capilar (mg/dL)",
  "Glicose"
  )

renomear_colunas <- c(
  "iniciais",
  "grupo",
  "etnia",
  "idade",
  "escolaridade",
  "doenca",
  "num_gestacoes",
  "gpsanguineo",
  "rh",
  "peso",
  "altura",
  "imc",
  "gordura",  
  "pressao_sis",
  "pressao_dias",
  "pressao_media", 
  "cintura",
  "abdomen",
  "quadril",
  "cintura_quadril",
  "rbc",
  "hgb",
  "hct",
  "vcm",
  "hcm",
  "chcm",
  "rdwcv",
  "rdwsd",
  "plt",
  "pct",
  "vpm",
  "pdw",
  "plcc",
  "plcr",
  "wbc",
  "neu",
  "lym",
  "mon", 
  "eos",
  "baso",
  "lic",
  "nlr",
  "colesterol_total",
  "hdl",
  "ldl_dosado",
  "vldl",
  "nao_hdl",
  "triglicerides",
  "hba1c",
  "creatinina",
  "filtr_glomerular",
  "tgp_alt",
  "tgo_ast",
  "acido_urico",
  "ck",
  "gama_gt",
  "anti_hiper",
  "medic_diabetes",
  "medic_hipercol",
  "tabagista",
  "elitista",
  "glicemia",
  "glicose"
  )

df1 <- df1 %>% dplyr::select(all_of(colunas_interesse))
colnames(df1) <- renomear_colunas

grupos_nulos <- df1 %>% dplyr::select(grupo) %>% is.na()
df1 <- df1 %>% 
  filter(!grupos_nulos) %>% 
  mutate(
    grupo = as.factor(grupo),
    etnia = coluna_numerica(etnia),
    escolaridade = as.factor(escolaridade),
    doenca = gsub("\\.", ",", doenca),
    gpsanguineo = coluna_numerica(gpsanguineo),
    rh = coluna_numerica(rh),
    peso = coluna_numerica(peso),
    altura = coluna_numerica(altura),
    imc = coluna_na_numerica(imc, "#DIV/0!", NA) %>% coluna_numerica() %>% round(2),
    gordura = coluna_na_numerica(gordura) %>% coluna_numerica(),
    pressao_sis = coluna_numerica(pressao_sis),
    pressao_dias = coluna_numerica(pressao_dias),
    pressao_media = coluna_numerica(pressao_media) %>% round(2),
    cintura = coluna_numerica(cintura),
    abdomen = coluna_numerica(abdomen),
    quadril = coluna_numerica(quadril),
    cintura_quadril = coluna_na_numerica(cintura_quadril, "#DIV/0!", NA) %>% coluna_numerica() %>% round(2),
    mon = coluna_numerica(mon),
    nlr = coluna_na_numerica(nlr, "#DIV/0!", NA) %>% coluna_numerica(),
    ldl_dosado = coluna_na_numerica(ldl_dosado, "#DIV/0!", NA) %>% coluna_numerica(),
    vldl = coluna_na_numerica(vldl, "#DIV/0!", NA) %>% coluna_numerica() %>% round(2),
    nao_hdl = coluna_numerica(nao_hdl) %>% round(2),
    hba1c = coluna_numerica(hba1c) %>% round(2),
    creatinina = coluna_numerica(creatinina),
    filtr_glomerular = coluna_na_numerica(filtr_glomerular, "#DIV/0!", NA) %>% coluna_numerica(),
    ck = coluna_numerica(ck),
    glicemia = coluna_numerica(glicemia),
    glicose = coluna_numerica(glicose)
    )

df1 <- df1 %>%
  mutate_at(vars(-c(iniciais, grupo, escolaridade, doenca, etnia, num_gestacoes)), as.numeric)%>%
  mutate(
    razaoldl = ldl_dosado/colesterol_total,
         num_gestacoes = ifelse(num_gestacoes == 1, 1, ifelse(num_gestacoes == 2, 2, 3))
         )
```

```{r tratamento_df2}
####  DF2: Dados Gestacionais

colunas_interesse <- c(
  "NOME    (iniciais)",
  "GRUPO      MN:0      MP:1",
  "Ano",
  "Há quantos anos",
  "PARTO                                     0:normal   1:cesariana   2:fórceps",
  "PESO BEBÊ (kg)",
  "SEXO BEBÊ 0:feminino   1:masculino",
  "MESMO PAI 0:não        1:sim      2:não se aplica (primigesta)",
  "INTERVALO ENTRE PARTOS (meses) 0:primigesta",
  "PARTO PREMATURO 0:não      1:sim",
  "GESTAÇÃO MÚLTIPLA  (gêmeos) 0:não   1:sim"
  )

renomear_colunas <- c(
  "iniciais",
  "grupo",
  "ano",
  "quantos_anos_evento",
  "tipo_parto",
  "peso_bebe",
  "sexo_bebe",
  "mesmo_pai",
  "intervalo_partos",
  "prematuro",
  "gemeos"
  )

df2 <- df2 %>% dplyr::select(all_of(colunas_interesse))
colnames(df2) <- renomear_colunas

grupos_nulos <- df2 %>% dplyr::select(grupo) %>% is.na()
df2 <- df2 %>% 
  filter(! grupos_nulos) %>% 
  mutate(
    grupo = as.factor(grupo),
    quantos_anos_evento = quantos_anos_evento %>% as.numeric(),
    peso_bebe = coluna_numerica(peso_bebe),
    tipo_parto = as.factor(coluna_numerica(tipo_parto)),
    prematuro = as.factor(prematuro)
    )
```

```{r tratamento_df3}
#### DF3: ELISAs

colunas_interesse <- c(
  "NOME    (iniciais)",
 "GRUPO      MN:0      MP:1", 
 "PAI-1 (ng/mL)",
 "Log PAI-1 (ng/mL)",
 "TROMBOMODULINA (ng/mL)",
 "ADMA (ng/mL)",
 "sFlt1 (pg/mL)",
 "Absorbâncias sFlt1",
 "AA-AT1 (ng/mL)"
)

renomear_colunas <- c(
  "iniciais",
 "grupo", 
 "pai1",
 "logpai1",
 "trombomodulina",
 "adma",
 "sflt1",
 "absor_sflt1",
 "aaat1"
)
df3 <- df3 %>% dplyr::select(all_of(colunas_interesse))

colnames(df3) <- renomear_colunas

df3 <- df3 %>% drop_na(grupo) %>% 
  mutate(
  pai1 = coluna_numerica(pai1) %>% round(2),
  logpai1 = coluna_numerica(logpai1) %>% round(2),
  trombomodulina = coluna_numerica(trombomodulina),
  adma = coluna_numerica(adma), 
  sflt1 = coluna_na_numerica(sflt1, "< curva", NA) %>% coluna_numerica() %>% round(2),
  absor_sflt1 = coluna_numerica(absor_sflt1) %>% round(2),
  aaat1 = coluna_numerica(aaat1) %>% round(2)
)

df3 <- df3 %>%
  mutate_at(vars(-iniciais), as.numeric)

# corrigindo outro erro de adma
df3$adma <- df3$adma %>% ifelse(. == 999999, NA, .) %>% as.numeric()
```

```{r tratamento_df4}
#### DF4: Imunoturbidimetria

colunas_interesse <- c(
   "NOME    (iniciais)",
 "GRUPO      MN:0      MP:1", 
 "DÍMERO-D (ng/mL)",
 "LOG DÍMERO-D"
)
renomear_colunas <- c(
  "iniciais",
 "grupo", 
 "dimero",
 "logdimero"
)
df4 <- df4 %>% dplyr::select(all_of(colunas_interesse))
colnames(df4) <- renomear_colunas

df4 <- df4 %>% 
  mutate_at(vars(-iniciais), as.numeric)

# alterando df4
df4 <- df4 %>% mutate(
    dimero = coluna_numerica(dimero),
    logdimero = coluna_numerica(logdimero) %>% round(2)
)
```

```{r tratamento_df5}
#### DF5: Doenças Crônicas

colunas_interesse <- c(
  "NOME    (iniciais)",
 "GRUPO      MN:0      MP:1", 
 "HIPERTENSÃO 0:não   1:sim",
 "DIABETES 0:não   1:sim",
 "HIPERCOLESTEROLEMIA 0:não   1:sim",
 "FIBROMIALGIA 0:não   1:sim",
 "GLAUCOMA 0:não   1:sim",
 "ENXAQUECA 0:não   1:sim",
 "HIPOTIREOIDISMO 0:não   1:sim",
 "ASMA 0:não   1:sim",
 "ESTEATOSE HEPÁTICA 0:não   1:sim",
 "SÍNDROME DO INTESTINO IRRITÁVEL 0:não   1:sim",
 "HEMANGIOMA  0:não   1:sim",
 "TROMBOFILIA  0:não   1:sim",
 "BRONQUITE  0:não   1:sim",
 "RINITE  0:não   1:sim",
 "OVÁRIOS POLICÍSTICOS 0:não   1:sim",
  "Transtorno de ansiedade generalizada (TAG)  0:não   1:sim",
 "SINUSITE 0:não 1:sim",
 "DEPRESSÃO 0:não   1:sim",
 "ARTROSE 0:não   1:sim",
 "LEUCOCITOSE 0:não   1:sim",
 "ANEMIA 0:não   1:sim",
 "SÍNDROME DO PÂNICO 0:não   1:sim",
 "GASTRITE 0:não   1:sim",
 "HEPATITE 0:não   1:sim",
 "CRISE ALÉRGICA 0:não   1:sim",
 "CISTITE 0:não   1:sim",
 "ANEMIA FALCIFORME 0: não 1:sim",
 "MIOMA UTERINO 0: não 1: sim",
 "CÁLCULO RENAL 0: não 1: sim",
 "CALCIFICAÇÃO MAMÁRIA 0: não 1: sim",
 "HIPOGLICEMIA 0: não 1: sim",
 "DERRAME DE VISTA 0: não 1: sim",
 "HIDRADENITE 0: não 1: sim",
 "GLOMERULOESCLEREOSE  0: não 1: sim",
 "PRÉ-DIABETES 0: não 1: sim",
  "BIPOLAR 0: não 1: sim",
  "TDAH 0: não 1: sim",
  "TEA 0: não 1: sim",
  "DOENÇA DE STILL 0: não 1: sim"
)

renomear_colunas <- c(
  "iniciais",
 "grupo", 
 "hipertensao",
 "diabetes",
 "hipercolesterolemia",
 "fibromialgia",
 "glaucoma",
 "enxaqueca",
 "hipotireoidismo",
 "asma",
 "esteatose_hepatica",
 "sindrome_intestino_irritavel",
 "hemangioma",
 "trombofilia",
 "bronquite",
 "rinite",
 "ovario_policistico",
 "tag",
 "sinusite",
 "depressao",
 "artrose",
 "leucocitose",
 "anemia",
 "sindrome_panico",
 "gastrite",
 "hepatite",
 "crise_alergica",
 "cistite",
 "anemia_falciforme",
 "mioma_uterino",
 "calculo_renal",
 "calcificacao_mamaria",
 "hipoglicemia",
 "derrame de vista",
 "hidradenite",
 "glomeruloesclerose",
 "pre_diabetes",
 "bipolaridade",
 "tdah",
 "tea",
 "still"
)

df5 <- df5 %>% dplyr::select(all_of(colunas_interesse))
colnames(df5) <- renomear_colunas

df5 <- df5 %>% 
  mutate_at(vars(-iniciais), as.numeric)
```

```{r tratamento_df6}
names(df6)[10] <- 'FILHOS VIVOS NO PERÍODO DA GESTAÇÃO: 0:sem filhos 1: um filho 2: dois ou mais filhos'

#### DF6: Aspectos Psicologicos

colunas_interesse <- c(
  "NOME    (iniciais)",
 "GRUPO      MN:0      MP:1", 
 "REDE DE APOIO             0:não   1:sim",                                                                          
 "PRIMEIRO FILHO     0:não   1:sim",
 "FILHOS VIVOS NO PERÍODO DA GESTAÇÃO: 0:sem filhos 1: um filho 2: dois ou mais filhos",
 "TRABALHAVA FORA       0:não       1:sim",                                                                          
 "RELACIONAMENTO COM O PAI                                  0:não tinha     1:ruim   2:normal   3:bom   4:excelente",
 "APOIO DO PARCEIRO            1:nenhum                 2:pouco                         3:muito"                    
 )

renomear_colunas <- c(
  "iniciais",
 "grupo", 
 "apoio",
 "1o_filho",
 "filhos_vivos",
 "trabalha",
 "relac_pai",
 "apoio_pai"
)

df6 <- df6 %>% dplyr::select(all_of(colunas_interesse))

colnames(df6) <- renomear_colunas

df6 <- df6 %>% drop_na(grupo) %>% 
  mutate(
    filhos_vivos = coluna_numerica(filhos_vivos),
  relac_pai = coluna_numerica(relac_pai),
)

df6 <- df6 %>%
  mutate_at(vars(-c(iniciais)), as.numeric)
```

```{r tratamento_df7}
#### DF7: Sindrome metabolica

colunas_interesse <- c(
 "GRUPO      MN:0      MP:1", 
 "USA MEDICAMENTO PARA HIPERCOLESTEROLEMIA 0:não 1:sim",                                
 "USA MEDICAMENTO PARA DIABETES 0:não 1:sim",
 "PA > 130/85 e/ou uso de anti-hipertensivo 0:não 1:sim",
 "CINTURA >88CM 0: não 1: sim",                                                       
 "TG > 150 mg/dL 0: não 1: sim",
 "HDL < 50 0: não 1: sim"
 )

renomear_colunas <- c(
 "grupo", 
 "anti_hipercolesterolemia",
 "anti_diabetes",
 "paalto",
 "cinturaaumentada",
 "tgalto",
 "hdlbaixo"
)

df7 <- df7 %>% dplyr::select(all_of(colunas_interesse))

colnames(df7) <- renomear_colunas

df7 <- df7 %>% drop_na(grupo) %>% 
  mutate(
  paalto = coluna_numerica(paalto),
  cinturaaumentada = coluna_numerica(cinturaaumentada),
  tgalto = coluna_numerica(tgalto),
  hdlbaixo = coluna_numerica(hdlbaixo)
)

df7[] <- lapply(df7, as.numeric)
df7 <- df7[, !(names(df7) %in% c("grupo"))]
```

```{r resumo_df}
posicoes_duplicadas <- which(duplicated(df1$iniciais))
df1$iniciais[posicoes_duplicadas] <- paste0(df1$iniciais[posicoes_duplicadas], "2")

posicoes_duplicadas <- which(duplicated(df2$iniciais))
df2$iniciais[posicoes_duplicadas] <- paste0(df2$iniciais[posicoes_duplicadas], "2")

posicoes_duplicadas <- which(duplicated(df3$iniciais))
df3$iniciais[posicoes_duplicadas] <- paste0(df3$iniciais[posicoes_duplicadas], "2")

posicoes_duplicadas <- which(duplicated(df5$iniciais))
df5$iniciais[posicoes_duplicadas] <- paste0(df5$iniciais[posicoes_duplicadas], "2")

df1 <- df1 %>% mutate(grupo = as.factor(grupo))
df2 <- df2 %>% mutate(grupo = as.factor(grupo))
df3 <- df3 %>% mutate(grupo = as.factor(grupo))
df5 <- df5 %>% mutate(grupo = as.factor(grupo))

df_completo <- left_join(df1 %>% select(-ck),
                         df2 %>% select(iniciais, grupo, quantos_anos_evento)) %>% 
               left_join(.,
                         df3 %>% select(iniciais, grupo, trombomodulina, adma),
                         by = join_by(iniciais, grupo), relationship = "many-to-many") %>%
               left_join(., 
                         df5 %>% select(iniciais,grupo,hipertensao,diabetes,hipercolesterolemia),
                         by = join_by(iniciais, grupo), relationship = "many-to-many") %>%
  select(- iniciais) %>% 
  # Inserindo variaveis
  mutate(
    # nenhuma numerica
    # categoricas
    sangueo = ifelse(gpsanguineo == 2, "1", "0"),
    categoriaimc = case_when(
      imc <= 24.99 ~ "magraza/eutrofia",
      imc <= 29.99 ~ "sobrepeso",
      TRUE ~ "obesidade") %>% as.factor(),
    escolaridade_bin = ifelse(escolaridade %in% c(3, 4), "superior", "basico") %>% as.factor(),
    imcbinario = ifelse(imc < 24.99, "normal", "alterado") %>% as.factor()
)

df_completo <- cbind(df_completo, df7)

df_completo$hipertensao <- ifelse(df_completo$hipertensao == 0 & df_completo$anti_hiper == 1, 1, df_completo$hipertensao)

# Reajustando niveis das variaveis categoricas
levels(df_completo$categoriaimc) <- c("magraza/eutrofia","sobrepeso","obesidade")
levels(df_completo$imcbinario) <- c("normal", "alterado")

cols <- df_completo %>% names()
cat <- c("grupo", "etnia", "escolaridade", "doenca", "num_gestacoes", "gpsanguineo",
         "rh", "medic_diabetes", "medic_hipercol", "tabagista", "elitista", "anti_hiper",
         "hipertensao", "diabetes", "hipercolesterolemia", "sangueo", "categoriaimc",
         "imcbinario", "escolaridade_bin")
num <- c("grupo", cols[! cols %in% cat])

df_num <- df_completo %>% select(all_of(num))
df_cat <- df_completo %>% select(all_of(cat))
```

```{r tema_graficos}
cor_verde = c("#4fb6a7")
cor_roxa = c("#652177")

cores = colorRampPalette(c("#4fb6a7","#652177"))
tema = theme_minimal() + 
       theme(axis.title.y = element_text(angle = 90, margin = unit(c(0.3, 0.5, 0.3, 0), "cm")),
             axis.title.x = element_text(margin = unit(c(0.3, 0, 0, 0), "cm")),
             axis.line.x = element_line(linewidth = 0.6, linetype=1),
             axis.line.y = element_line(linewidth = 0.6, linetype=1),
             axis.ticks.y = element_line(linewidth = 0.6, linetype = 1),
             axis.text = element_text(size=10),
             legend.position = "right",
             plot.margin = unit(c(0.3, 0.4, 0.3, 0.4), "cm"),
             plot.subtitle = element_text(hjust = 0.5, vjust= 4))
theme_set(tema)
```

# Resumo testes de hipóteses

## Dados numéricos

Para os dados numéricos, os testes tiveram por hipótese geral:

```{=tex}
\begin{eqnarray}
        {
        \left\{\begin{array}{lcc}
        H_{0}: {\theta_{Grupo~MN} = \theta_{Grupo~MP}} \\
        H_{1}: {\theta_{Grupo~MN} \neq \theta_{Grupo~MP}}
        \end{array}\right.
        }    \nonumber
    \end{eqnarray}
```
```{r funcao_teste_hipotese}
realizar_teste <- function(dataframe, variavel) {
  
  dataframefiltrado <- dataframe %>% drop_na(grupo) %>% mutate(grupo = ifelse(grupo == "0", "MN", "MP")) 
  grupo_MN<- dataframefiltrado %>% filter(grupo == "MN") %>% pull(variavel)
  grupo_MP<- dataframefiltrado %>% filter(grupo == "MP") %>% pull(variavel)

  tabela <- dataframefiltrado %>% group_by(grupo) %>%
    summarise(
      N = sum(!is.na( !!sym(variavel) )),
      Nulo =  sum( is.na( !!sym(variavel) )),
      `Média` = mean( !!sym(variavel) , na.rm = T),
      "DesPad" = sd( !!sym(variavel) , na.rm = T),
      "Min" = min( !!sym(variavel) , na.rm = T),
      "Q1" = quantile( !!sym(variavel) , na.rm = T, .25)[[1]],
      "Mediana" = quantile( !!sym(variavel) , na.rm = T, .5)[[1]],
      "Q3" = quantile( !!sym(variavel) , na.rm = T, .75)[[1]],
      "Máx" = max( !!sym(variavel) , na.rm = T),
      `P(Norm)` = shapiro.test( !!sym(variavel) )$p.value,
      `P(Test-T)` = t.test(grupo_MN, grupo_MP, alternative = "two.sided")$p.value,
      `P(Manh-W)` = wilcox.test(grupo_MN, grupo_MP, correct = FALSE,  alternative = "two.sided")$p.value,
      `Variável` = variavel
    )
  
  tabela <- tabela %>% select(`Variável`, everything())
  return(tabela)
}
```

```{r aplicando_teste_numericos}
### Idade:
variavel <- "idade"
teste <- realizar_teste(df_num, variavel)
tabela_resumo <- teste

todas_variaveis <- names(df_num)[-c(1,2)]
for(variavel in todas_variaveis){
  teste <- realizar_teste(df_num, variavel)
  tabela_resumo <- rbind(tabela_resumo, teste)
}

kbl(
  tabela_resumo %>% arrange(`P(Manh-W)`), 
  digits = 3,
  format.args = list(decimal.mark = ',', big.mark = ".") 
  ) %>%
  kable_paper(full_width = F) %>%
  column_spec(1, bold = T) %>%
  collapse_rows(columns = c(1,13:14))
```

## Dados categóricos

```{r}
# Teste de hipóteses para dados categóricos
hipo_categorica <- function(dados, grupo, variavel){
  
  dados <- dados %>% drop_na(grupo) %>% mutate(grupo = ifelse(grupo == "0", "MN", "MP")) 
  data_grupo <- dados %>% dplyr::select( !!sym(grupo) ) %>% pull( !!sym(grupo) )
  data_variavel <- dados %>% dplyr::select( !!sym(variavel) ) %>% pull( !!sym(variavel) )
  tab = xtabs(~ data_variavel + data_grupo) # tabela de frequencia
  teste <- stats::chisq.test(tab, simulate.p.value = TRUE,  B = 10000)
  
  tabela <- list(
    `Variável` = variavel,
    Categorias = rownames(tab),
    MN = tab[,"MN"],
    `MN(%)` = paste0( (tab[,"MN"]/sum(tab[,"MN"]) * 100) %>% round(2) ,"%" ),
    MP = tab[,"MP"],
    `MP(%)` = paste0( (tab[,"MP"]/sum(tab[,"MP"]) * 100) %>% round(2) ,"%" ),
    `P(Teste)` = teste$p.value
    ) %>% as_tibble()
   
  return(tabela)
  }
```

```{r aplicando_teste_categoricos}
### Etnia:
variavel <- "etnia"
teste <- hipo_categorica(df_cat, "grupo", variavel)
tabela_resumo_cat <- teste

todas_variaveis <- names(df_cat)[-c(1,2)]

todas_variaveis <- todas_variaveis[-2] # tirando doenca por enquanto

for(variavel in todas_variaveis){
  teste <- hipo_categorica(df_cat, "grupo", variavel)
  tabela_resumo_cat <- rbind(tabela_resumo_cat, teste)
}

kbl(
  tabela_resumo_cat %>% arrange(`P(Teste)`), 
  digits = 3,
  format.args = list(decimal.mark = ',', big.mark = ".") 
  ) %>%
  kable_paper(full_width = F) %>%
  column_spec(1, bold = T) %>%
  collapse_rows(columns = c(1,7))
```

# Outras Informações

-   Descritiva ADMA e trombomodulina

```{r}
# Gráfico de histograma
g1 <- ggplot(df3, aes(x = adma)) +
  geom_histogram(fill = "#4C78A8", color = "#4C78A8", bins = 10, alpha = 0.7) +
  labs(title= "Descritivas ADMA\n\n Histograma ADMA", x = "adma", y = "Frequência") +
  theme_minimal() +
  theme(axis.text = element_text(size = 11), 
        axis.title = element_text(size = 13),
        plot.title = element_text(size = 15)) +
  facet_grid(.~1, scales = "free_y")

# Gráfico de boxplot
g2 <- ggplot(df3, aes(y = adma)) +
  geom_boxplot(fill = "#F28E2B", color = "#F28E2B", alpha = 0.7) +
  labs(title = "\n\nBoxplot ADMA", y = "adma") +
  theme_minimal() +
  theme(axis.text = element_text(size = 11), 
        axis.title = element_text(size = 13),
        plot.title = element_text(size = 15))

g1 + g2

# Gráfico de histograma
g3 <- ggplot(df3, aes(x = trombomodulina)) +
  geom_histogram(fill = "#4C78A8", color = "#4C78A8", bins = 10, alpha = 0.7) +
  labs(title = "Descritivas trombomodulina\n\n Histograma trombomodulina", x = "trombomodulina", y = "Frequência") +
  theme_minimal() +
  theme(axis.text = element_text(size = 11), 
        axis.title = element_text(size = 13),
        plot.title = element_text(size = 15)) +
  facet_grid(.~1, scales = "free_y")

# Gráfico de boxplot
g4 <- ggplot(df3, aes(y = trombomodulina)) +
  geom_boxplot(fill = "#F28E2B", color = "#F28E2B", alpha = 0.7) +
  labs(title = "\n\nBoxplot trombomodulina", y = "trombomodulina") +
  theme_minimal() +
  theme(axis.text = element_text(size = 11), 
        axis.title = element_text(size = 13),
        plot.title = element_text(size = 15))

g3 + g4
```

-   Sobre Hipertensão e Usar anti hipertensivos

```{r}
Hipertensao <- df_completo$hipertensao  %>% as.factor(); AntiHiper <- df_completo$anti_hiper %>% as.factor()
tab <- xtabs(~  Hipertensao + AntiHiper)
tab
```

-   Comparação grupos em relação a hipertensão e uso de anti hipertensivos

```{r}
manti_hiper<- df_completo %>% select(grupo, anti_hiper)
table(manti_hiper)

mhiper<- df_completo %>% select(grupo, hipertensao)
table(mhiper)
```

-   Correlações:

```{r}
data <- df_num %>% drop_na() %>% select(-grupo)

num_sig <- tabela_resumo %>% filter(`P(Manh-W)` < 0.1 | `P(Test-T)` < 0.1) %>% pull("Variável") %>% unique()
data_sig <- data %>% select(all_of(num_sig))

corrplot::corrplot(cor(data_sig) %>% round(3),
                   diag = F, type = "upper", order="hclust"
                   )

## Tirando correlacionadas
num_sig_sem_corr <- c(
  "imc", "pressao_media", "ldl_dosado", "colesterol_total", "filtr_glomerular", "triglicerides")

data_sig_sem_corr <- data %>% select(all_of(num_sig_sem_corr))
corrplot::corrplot(cor(data_sig_sem_corr), 
                   method = "color", diag = F, type = "upper",addCoef.col = "black", order="hclust"
                   )
```

# Regressões lineares

```{r covariaveis_regressao}
df_reg <- df_completo %>% 
  select(
    grupo,
    # numericas
    idade, cintura, razaoldl, ldl_dosado, pressao_media, pressao_dias, pressao_sis, creatinina, trombomodulina,
    imc, adma, lym, filtr_glomerular, rbc, wbc, hdl, triglicerides, colesterol_total, anti_hipercolesterolemia, anti_diabetes, paalto, cinturaaumentada, tgalto, hdlbaixo,
    # categoricas
    hipertensao, gpsanguineo, escolaridade_bin, categoriaimc, imcbinario, anti_hiper, sangueo, escolaridade
    ) %>%
  mutate(escolaridade_niveis = case_when(
    escolaridade %in% c(0, 1) ~ "fundamental",
    escolaridade %in% c(2, 5) ~ "medio",
    escolaridade %in% c(3, 4) ~ "superior")) %>% 
  as_tibble()

#df_reg %>% glimpse()
# transformando as categoricas
df_reg <- df_reg %>% mutate(
  anti_hipercolesterolemia = as.factor(anti_hipercolesterolemia),
  anti_diabetes = as.factor(anti_diabetes),
  paalto = as.factor(paalto),
  cinturaaumentada = as.factor(cinturaaumentada),
  tgalto = as.factor(tgalto),
  hdlbaixo = as.factor(hdlbaixo),
  hipertensao = as.factor(hipertensao),
  anti_hiper = as.factor(anti_hiper)
)
levels(df_reg$escolaridade) <- c( "4serie","fundamental","medio","tecnico","superior","posgrad")
levels(df_reg$escolaridade_niveis) <- c( "fundamental","medio","superior")
```

```{r funcao_resumo_ajuste}
ConcluiAjuste <- function(fit){
  tabela <- cbind(
    Variavel = names(coef(fit)),
    Efeito = paste0(100 * (exp( coef(fit)) - 1) %>% round(4),"%")
    ) %>% as_tibble()
  
  tabela[1,2] = "-" # considerando o grupo base
  
  kbl(tabela) %>%
  kable_paper(full_width = F) %>%
  column_spec(1, bold = T)
}
```

## PAS

-   **M1**: Modelo sem escolaridade

```{r}
modelopas <- lm(pressao_sis ~ grupo + idade + anti_hiper + imc, data = df_reg)
modelopas %>% summary()
##reglin::ggresiduals(modelopas)
shapiro.test(modelopas$residuals)
print("Durbin-Watson Test for Autocorrelated Errors")
durbinWatsonTest(modelopas)
```

-   **M2**: Modelo com escolaridade sendo significativa

```{r}
modelopas2 <- lm(pressao_sis ~ grupo + idade + anti_hiper + imc + escolaridade_niveis, data = df_reg)
modelopas2 %>% summary()
##reglin::ggresiduals(modelopas2)
shapiro.test(modelopas2$residuals)
print("Durbin-Watson Test for Autocorrelated Errors")
durbinWatsonTest(modelopas2)
```

-   Comparação **M1** e **M2**:

Indica pelo menos um nível de escolaridade significativo.

```{r}
anova(modelopas, modelopas2)
```

## PAD

-   **M1**: Modelo sem escolaridade

```{r}
modelopad <- lm(pressao_dias ~ grupo + anti_hiper + imc + idade, data = df_reg)
modelopad %>% summary()
##reglin::ggresiduals(modelopad)
shapiro.test(modelopad$residuals)
print("Durbin-Watson Test for Autocorrelated Errors")
durbinWatsonTest(modelopad)
```

-   **M2**: Modelo com escolaridade sendo significativa

```{r}
modelopad2 <- lm(pressao_dias ~ grupo + anti_hiper + imc + idade + escolaridade_niveis, data = df_reg)
modelopad2 %>% summary()
##reglin::ggresiduals(modelopad2)
shapiro.test(modelopad2$residuals)
print("Durbin-Watson Test for Autocorrelated Errors")
durbinWatsonTest(modelopad2)
```

-   Comparação **M1** e **M2**:

Indica pelo menos um nível de escolaridade significativo.

```{r}
anova(modelopad, modelopad2)
```

## PAM

-   **M1**: Modelo sem escolaridade

```{r}
modelopam <- lm(pressao_media ~ grupo + anti_hiper + imc + idade, data = df_reg)
modelopam %>% summary()
#reglin::ggresiduals(modelopam)
shapiro.test(modelopam$residuals)
print("Durbin-Watson Test for Autocorrelated Errors")
durbinWatsonTest(modelopam)
```

-   **M2**: Modelo com escolaridade sendo significativa
```{r}
modelopam2 <- lm(pressao_media ~ grupo + anti_hiper + imc + idade + escolaridade_niveis, data = df_reg)
modelopam2 %>% summary()
#reglin::ggresiduals(modelopam2)
shapiro.test(modelopam2$residuals)
print("Durbin-Watson Test for Autocorrelated Errors")
durbinWatsonTest(modelopam2)
```

-   Comparação **M1** e **M2**:

Indica pelo menos um nível de escolaridade significativo.

```{r}
anova(modelopam, modelopam2)
```

## IMC

```{r}
modeloimc <- lm(imc ~ grupo + pressao_media + triglicerides, df_reg)
#outlierTest(modeloimc) # uma observacao influente, tira-la
#shapiro.test(modeloimc$residuals) # essa observacao fura normalidade

modeloimc <- lm(imc ~ grupo + pressao_media + triglicerides, df_reg[-188,])
#outlierTest(modeloimc) # mais observacao influente, mas nao vamos tira-la pq tem normalidade

summary(modeloimc)
shapiro.test(modeloimc$residuals)
#reglin::ggresiduals(modeloimc)
print("Durbin-Watson Test for Autocorrelated Errors")
durbinWatsonTest(modeloimc)
```

## LDL

```{r}
modeloldl <- lm(ldl_dosado ~ grupo + idade, df_reg)
summary(modeloldl)
shapiro.test(modeloldl$residuals)
qqnorm(modeloldl$residuals); qqline(modeloldl$residuals)
#reglin::ggresiduals(modeloldl)
#outlierTest(modeloldl) # ha pontos influentes, mas nao ajudam na normalidade, precisa de muitos e piora o r2
print("Durbin-Watson Test for Autocorrelated Errors")
durbinWatsonTest(modeloldl)
```

## Trombomodulina (creatinina poderia entrar se fosse importante)

```{r}
modelotromb <- lm(trombomodulina ~ grupo + escolaridade_bin, data = df_reg)
summary(modelotromb)
shapiro.test(modelotromb$residuals)
#reglin::ggresiduals(modelotromb)
print("Durbin-Watson Test for Autocorrelated Errors")
durbinWatsonTest(modelotromb)
```

## ADMA

### Modelo Normal para ADMA

- Tiramos 1 observação influente, resultou em melhoria do $R^2_{Ajustado}$ e nas estimativas dos coeficientes (Maior mudança: Intercepto saiu de 204 para 101; idade de -5,7 para -2,5)

```{r}
modeloadma <- lm(adma ~ idade + ldl_dosado, df_reg[-c(5),])
summary(modeloadma)
shapiro.test(modeloadma$residuals)

reglin::ggresiduals(modeloadma)
#outlierTest(modeloadma) # ha pontos influentes
print("Durbin-Watson Test for Autocorrelated Errors")
durbinWatsonTest(modeloadma)
```

- Tiramos 2 observações influentes e a regressão deixa de ser significativa (inclusive sem ldl):

Isso gera mais influentes, tirando-os, continua não significativa.

```{r}
modeloadma2 <- lm(adma ~ idade + ldl_dosado, df_reg[-c(5,71),])
summary(modeloadma2)
```

### Modelo MLG para ADMA

- O gráfico de ADMA indicou que assume valores maiores que zero e com cauda longa;

```{r}
df_adma = df_reg %>% drop_na(adma)

plot(
  density(df_adma$adma), 
  main="Densidade de ADMA completo", lwd=3
  )
```

#### Adma modelo Gama com todas informações

```{r}
M3 = glm(adma ~ grupo, family=Gamma(link="log"), data = df_reg)
summary(M3)
tbl_regression(M3, exponentiate = TRUE)
ConcluiAjuste(M3)
#plot(M3$fitted.values, residuals(M3, type = "pearson"))
```

```{r}
M3 = glm(adma ~ grupo + idade + ldl_dosado, family=Gamma(link="log"), data = df_reg)
summary(M3)
tbl_regression(M3, exponentiate = TRUE)
ConcluiAjuste(M3)
#plot(M3$fitted.values, residuals(M3, type = "pearson"))
```

```{r}
M3 = glm(adma ~ idade + ldl_dosado, family=Gamma(link="log"), data = df_reg)
summary(M3)
tbl_regression(M3, exponentiate = TRUE)
ConcluiAjuste(M3)
#plot(M3$fitted.values, residuals(M3, type = "pearson"))
```

- Exemplo de resíduos ruins

```{r}
M3 = glm(adma ~ grupo + ldl_dosado, family=Gamma(link="log"), data = df_reg)
summary(M3)
tbl_regression(M3, exponentiate = TRUE)
ConcluiAjuste(M3)
hnp(M3)
plot(M3$fitted.values, residuals(M3, type = "pearson"))
```

#### Adma modelo Gama sem algumas informações

- Há 4 valores maiores que 200, todos do grupo 1 (com eclâmpsia);

```{r}
plot(
  density(df_adma$adma[df_adma$adma < 200]), 
  main="Densidade de ADMA sem adma > 200", lwd=3
  )

df_adma <- df_adma %>% filter(adma < 200)
```

- Abaixo vemos como retirar esses casos extremos contribuiram para a melhoria de algumas estimativas iniciais, **o desvio padrão do grupo MP reduziu de 167 para 38**

- Após a retirada os dados continuaram balenceados por grupo;

```{r}
kbl(
  rbind(
    realizar_teste(df_num %>% rename(adma_antes = adma), "adma_antes"),
    realizar_teste(df_adma %>% rename(adma_depois = adma), "adma_depois")
  ),
  digits = 3,
  format.args = list(decimal.mark = ',', big.mark = ".") 
  ) %>%
  kable_paper(full_width = F) %>%
  column_spec(1, bold = T)
```

**Principais mudanças:** 

- Um modelo com *idade e ldl_dosado* ou com *grupo e ldl_dosado* ou com todos juntos já não é mais significativo
- Melhora-se os resíduos

```{r}
M3 = glm(adma ~ grupo + cintura, family=Gamma(link="log"), data = df_adma)
summary(M3)
tbl_regression(M3, exponentiate = TRUE)
ConcluiAjuste(M3)
hnp(M3)
plot(M3$fitted.values, residuals(M3, type = "pearson"))
```

```{r}
M3 = glm(adma ~ grupo + categoriaimc, family=Gamma(link="log"), data = df_adma)
summary(M3)
tbl_regression(M3, exponentiate = TRUE)
ConcluiAjuste(M3)
#hnp(M3)
#plot(M3$fitted.values, residuals(M3, type = "pearson"))
```

```{r}
M3 = glm(adma ~ categoriaimc + escolaridade, family=Gamma(link="log"), data = df_adma)
summary(M3)
tbl_regression(M3, exponentiate = TRUE)
ConcluiAjuste(M3)
#hnp(M3)
#plot(M3$fitted.values, residuals(M3, type = "pearson"))
```

```{r}
M3 = glm(adma ~ cintura + escolaridade, family=Gamma(link="log"), data = df_adma)
summary(M3)
tbl_regression(M3, exponentiate = TRUE)
ConcluiAjuste(M3)
#hnp(M3)
#plot(M3$fitted.values, residuals(M3, type = "pearson"))
```

#### Mesma ideia para Normal

- O que era significativo no modelo inicial, passa a ser não significativo;
- Melhor interpretação que o MLG;
- Conclusão similar a todos demais;
- Melhorou resíduos;
- Regressão significativa;

```{r}
modeloadma3 <- lm(adma ~ grupo + categoriaimc + escolaridade, df_adma)
summary(modeloadma3)
shapiro.test(modeloadma3$residuals)

reglin::ggresiduals(modeloadma3)
#outlierTest(modeloadma3) # ha pontos influentes
print("Durbin-Watson Test for Autocorrelated Errors")
durbinWatsonTest(modeloadma3)
```

- Transformação na resposta, log(adma) normaliza resíduos
- R2ajustado pouco penalizado

```{r}
modeloadma4 <- lm(log(adma) ~ grupo + categoriaimc + escolaridade, df_adma)
modeloadma4 %>% summary()
shapiro.test(modeloadma4$residuals)
```

```{r}
modeloadma4 <- lm(log(adma) ~ grupo + categoriaimc + escolaridade_niveis, df_adma)
modeloadma4 %>% summary()
shapiro.test(modeloadma4$residuals)
```

# Cálculo Amostral

Optou-se por variar o $\beta$ no estudo (1 - $\beta$ indica o poder do teste). Testes mais poderosos implicam em maior rigor do tamanho amostral, espera-se aumento do tamanho da amostra quando avaliar isso. Vale lembrar que usualmente usa-se o poder de 90%.

```{r}
df_calc_amostra_mean <- df_reg %>% 
  group_by(grupo) %>% 
  summarise(
    media_PAS = mean(pressao_sis, na.rm = T),
    media_PAD = mean(pressao_dias, na.rm = T),
    media_PAM = mean(pressao_media, na.rm = T),
    media_IMC = mean(imc, na.rm = T),
    media_LDL = mean(ldl_dosado, na.rm = T),
    media_CIN = mean(cintura, na.rm = T)
    )

df_calc_amostra_var <- df_reg %>% 
  group_by(grupo) %>% 
  summarise(
    var_PAS   = var(pressao_sis, na.rm = T),
    var_PAD   = var(pressao_dias, na.rm = T),
    var_PAM   = var(pressao_media, na.rm = T),
    var_IMC   = var(imc, na.rm = T),
    var_LDL   = var(ldl_dosado, na.rm = T),
    var_CIN   = var(cintura, na.rm = T)
    )

## Calculo
var1 <- df_calc_amostra_var %>% filter(grupo == 0) %>% select(-grupo)
var2 <- df_calc_amostra_var %>% filter(grupo == 1) %>% select(-grupo)
alpha <- 0.05
beta <- c(0.01,0.05,0.1)
dif = abs(
  df_calc_amostra_mean %>% filter(grupo == 0) %>% select(-grupo) - 
  df_calc_amostra_mean %>% filter(grupo == 1) %>% select(-grupo)
  ) # dif medias

z2 <- qnorm(1 - alpha/2)
zbeta <- qnorm(1 - beta)

#se o erro aumenta, o n diminui. peq erros maior n
lista_n <- list()

for (i in 1:ncol(var1)){
  v1 = var1[[i]]; v2 = var2[[i]]; delta = dif[[i]]
  n = ((v1 + v2) * (z2 + zbeta)^2) / (delta^2)
  lista_n = list.append(
    lista_n,
    list(
      "Poder" = paste0( (1-beta)*100,"%"),
      "Tamanho por grupo" = n %>% round(),
      "Tamanho Amostral Total" = 2*n %>% round()
    )
  )

}
```

Para o cálculo, considerou-se as variâncias por grupo e a diferença das médias por grupo, resumo abaixo:

```{r}
kbl(
  df_calc_amostra_var,
  digits = 0,
  format.args = list(decimal.mark = ',', big.mark = "."), 
  caption = "Cálculo das variâncias por grupo"
  ) %>%
  kable_paper(full_width = F) %>%
  column_spec(1, bold = T)

kbl(
  dif,
  digits = 0,
  format.args = list(decimal.mark = ',', big.mark = "."), 
  caption = "Cálculo da diferença das médias por grupo"
  ) %>%
  kable_paper(full_width = F)
```

O Resultado obtido está abaixo:

```{r}
# ordem de cada calc amostral, 1 eh pas, 2 eh pad...
variavel = c("PAS", "PAD", "PAM", "IMC", "LDL", "CINTURA")

lista_n[[1]] %>% as_tibble() %>% 
  kable(caption = "Cálculo do tamanho amostral para PAS") %>%
  kable_styling("striped", full_width = F)

lista_n[[2]] %>% as_tibble() %>% 
  kable(caption = "Cálculo do tamanho amostral para PAD") %>%
  kable_styling("striped", full_width = F)

lista_n[[3]] %>% as_tibble() %>% 
  kable(caption = "Cálculo do tamanho amostral para PAM") %>%
  kable_styling("striped", full_width = F)

lista_n[[4]] %>% as_tibble() %>% 
  kable(caption = "Cálculo do tamanho amostral para IMC") %>%
  kable_styling("striped", full_width = F)

lista_n[[5]] %>% as_tibble() %>% 
  kable(caption = "Cálculo do tamanho amostral para LDL") %>%
  kable_styling("striped", full_width = F)

lista_n[[5]] %>% as_tibble() %>% 
  kable(caption = "Cálculo do tamanho amostral para CINTURA") %>%
  kable_styling("striped", full_width = F)
```
